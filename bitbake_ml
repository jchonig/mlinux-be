#!/bin/bash

progname=$(basename $0)

add_env () {
    while read env; do
	[[ ${env} =~ ([^=]+)= ]]
	case ${BASH_REMATCH[1]} in
	    MTADM_PASSWORD|MACHINE|LANG)
		echo "-e ${env}"
		;;
	esac
    done < <(env)
}

# Container is named mlinux-N where N is the major version
MLINUX_VERSION=$(expr $(basename $PWD) : '\(.*-[0-9]*\)\..*')
if [ -z "${MLINUX_VERSION}" ]; then
    MLINUX_VERSION=$(git status --ignore-submodules -b | sed -nr '/^HEAD/s/HEAD detached at ([0-9]+)\..*/mlinux-\1/p')
fi
if [ -z "${MLINUX_VERSION}" ]; then
    echo "Unable to determine mLinux version from directory name or git" >&2; exit 1
fi

IMAGE=jchonig/mlinux-be
do_pull=missing

while [ $# -gt 0 ]; do
    case "${1}" in
	--setup)
	    progname=setup_ml
	    shift
	    ;;
	--local)
	    IMAGE=mlinux-be
	    shift
	    ;;
	--pull)
	    do_pull=always
	    shift
	    ;;
	*)
	    break
	    ;;
    esac
done

# Figure out what we are supposed to do
case ${progname} in
    bitbake*)
	CMD="${*}"
	;;
    setup*)
	CMD="--setup ${*}"
	;;
    *)
	echo "Unknown script link ${progname}" 2>&1
	exit 1
	;;
esac

BUILD_DIR="/$(basename ${PWD})"

# Find any linked layers and mount them as volumes
VOLUMES="-v ${PWD}:${BUILD_DIR}"
for layer in $(find layers -maxdepth 1 -type l); do
    layer_base=$(basename ${layer})
    layer_src=$(readlink -f ${layer})
    layer_mp="${BUILD_DIR}/layers/${layer_base}"
    VOLUMES="${VOLUMES} -v ${layer_src}:${layer_mp}"
    # Ensure the layers are in the bblayers.conf file
    if [ -e build/conf/bblayers.conf ]; then
	if ! grep -q "${layer_mp}" build/conf/bblayers.conf; then
	    sed -i -e "\%${BUILD_DIR}/layers/user-layer%a\\" -e "			${layer_mp} \\\\" build/conf/bblayers.conf
	fi
    fi
done

# It's necessary to pass our symbolic and numeric user and group info
# to the container so the run script will work properly.
docker run -it \
       -e BUILD_USER=${USER} \
       -e BUILD_GROUP=$(groups | cut -d' ' -f1) \
       -e BUILD_UID=$(id -u) \
       -e BUILD_GID=$(id -g) \
       -e BUILD_DIR=${BUILD_DIR} \
       $(eval add_env) \
       ${VOLUMES} \
       --pull ${do_pull} \
       ${IMAGE}:${MLINUX_VERSION} ${CMD}
